<!DOCTYPE html>
<style>
#puzzle div {
    height: 50px;
}
#puzzle span {
    display: inline-block;
    border: 1px solid black;
    min-width: 50px;
    min-height: 50px;
}
span.selected {
    background-color: green;
}
span.square {
    border-color: red !important;
}
</style>

<div id="puzzle">
</div>
<input type="number" id="sum" value="5" style="width: 3em"/>.
<input type="number" id="intersections" value="2" style="width: 3em"/>
<button onclick="generateAndRender()">Generate puzzle</button>

<script>

const STICKS_MIN = 2;
const STICKS_MAX = 5;
const STICK_LENGTH_MIN = 5;
const STICK_LENGTH_MAX = 10;

const RANGE_MIN = -50;
const RANGE_MAX = 50;
const SQUARE_MIN = -10;
const SQUARE_MAX = 10;
const DISALLOWED = new Set(["-1*1", 0, "0", "0*0", "1*1"]);

var sticks = new Array();
var pivots = new Array();
pivots.push(null);

function generateAndRender() {
    var gen = generatePuzzle();
    function nextStep() {
        var done = gen.next().done;
        render();
        if (!done) {
            requestAnimationFrame(nextStep);
        }
    }
    nextStep();
}

function render() {
    var puzzle = document.getElementById('puzzle');
    while (puzzle.childElementCount > 0) {
        puzzle.removeChild(puzzle.lastElementChild);
    }

    for (var stick of sticks) {
        var stickElement = document.createElement('div');
        for (var entry of stick) {
            var entryElement = document.createElement('span');
            entryElement.textContent = "" + entry;
            stickElement.appendChild(entryElement);
        }
        puzzle.appendChild(stickElement);
    }
}

function* generatePuzzle() {
    var sum = document.getElementById('sum').value;
    var intersections = document.getElementById('intersections').value;
    var stickCount = intersections + 1;

    yield;

    for (var s = 0; s < stickCount; s++) {
        yield* generateStick(sum);
    }
}

function* generateStick(sum) {
    var stickLength = rand(STICK_LENGTH_MIN, STICK_LENGTH_MAX);
    var squareIndex = rand(0, stickLength - 1);
    var stick = new Array();
    sticks.push(stick);
    yield;

    while (stick.length < stickLength) {
        var used = unionValues();

        var assignedNumber;
        if (stick.length == stickLength - 1) {
            assignedNumber = sum - sumOf(stick);
        } else if (stick.length == squareIndex) {
            assignedNumber = rand(SQUARE_MIN, SQUARE_MAX);
            assignedNumber = assignedNumber + "*" + Math.abs(assignedNumber);
        } else {
            assignedNumber = rand(RANGE_MIN, RANGE_MAX);
        }
        stick.push(assignedNumber);

        yield;

        if (used.has(assignedNumber)) {
            console.log(`Dropping ${assignedNumber} for reuse`);
            stick.pop();
        } else if (DISALLOWED.has(assignedNumber)) {
            console.log(`Dropping ${assignedNumber} for disallowed`);
            stick.pop();
        } else if (stick.length == stickLength - 1 && (assignedNumber < RANGE_MIN || assignedNumber > RANGE_MAX)) {
            console.log(`Dropping ${assignedNumber} for range violation`);
            stick.pop();
        }
    }
    yield;
}

function rand(min, max) {
    return min + Math.floor(Math.random() * (max - min + 1));
}

function unionValues() {
    var values = new Set();
    for (stick of sticks) {
        values = values.union(new Set(stick));
    }
    return values;
}

function sumOf(stick) {
    var sum = 0;
    for (var num of stick) {
        sum = sum + eval(num);
    }
    return sum;
}

</script>
